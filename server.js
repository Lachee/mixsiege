!function(e){var s={};function n(i){if(s[i])return s[i].exports;var t=s[i]={i:i,l:!1,exports:{}};return e[i].call(t.exports,t,t.exports,n),t.l=!0,t.exports}n.m=e,n.c=s,n.d=function(e,s,i){n.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,s){if(1&s&&(e=n(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var t in e)n.d(i,t,function(s){return e[s]}.bind(null,t));return i},n.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(s,"a",s),s},n.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},n.p="",n(n.s=2)}([function(e,s){e.exports=require("@mixer/shortcode-oauth")},function(e,s){e.exports=require("ws")},function(e,s,n){const{v1:i,v5:t}=n(3),o=(n(4),n(5)),r=n(10),c=n(11).createClient(),l=n(12),u=n(13),a=n(14),h=n(1),d=u(),m=l({saveUninitialized:!1,store:new(n(15)(l))({client:c}),secret:"$hgjfdsaa7y8",resave:!1});d.set("view engine","ejs"),d.use(u.static("public")),d.use(m);const{OAuthClient:p}=n(0),f="8f1f2333d089d0098efb4c1b2599b54e1a696ffc5850f121",x=new p({clientId:f,scopes:["interactive:robot:self"]}),g=n(16).Carina;g.WebSocket=h;const C=new g({isBOt:!0,queryString:{"Client-ID":f}}).open(),b=a.createServer(d),E=new h.Server({clientTracking:!1,noServer:!0});let A=new r({stdTTL:120,checkperiod:30,useClones:!1,deleteOnExpire:!0});A.on("expired",(e,s)=>{s.close("Exceeded maximum pending time"),console.log("Pending Expired",s.uuid)});let I=new r({stdTTL:86400,checkperiod:600,useClones:!1,deleteOnExpire:!0});function _(e,s="v5"){if("v1"==s)return i();let n=t(e.connection.remoteAddress,t.DNS);return console.log(e.connection.remoteAddress,n),n}I.on("expired",(e,s)=>{s.close("Exceeded maxium active time"),console.log("Consumer Expired",s.uuid)}),d.get("*",async(e,s)=>{let n=e.query.uuid||"v5",i=e.session.uuid;e.query.remember&&(console.log("Remembered Connection (manual IP based uuidv5)"),n="v5",i=_(e,n));let t=I.get(i||""),r=null;if(i&&null!=t)console.log("Connection Returned",i),r=t;else{let s=_(e,n),i=await x.getCode();console.log("Connection Created",s),r=new o(s,i,{MIXER_API:"https://mixer.com/api/v1",MIXER_CLIENT_ID:f,MIXER_GAME_VERSION:461588,mixerOAuthClient:x,carnia:C}),r.keepAlive=void 0!==e.query.keepAlive,r.onClose=()=>{A.del(s),r.keepAlive?(console.log("Connection Remembered",s,3600),I.ttl(s,3600)):(console.log("Connection Forgotten",s),I.del(s))},A.set(s,r),e.session.uuid=s}r.keepAlive=void 0!==e.query.keepAlive,console.log(r.uuid,"keep alive:"+r.keepAlive,e.query.keepAlive),s.render("base",{consumer:r,port:3e3})}),E.on("connection",(async function(e,s){const n=s.session.uuid,i=A.get(n),t=I.get(n);if(null==i)return null==t?(console.warn("Invalid connection, no consumer found."),void s.session.destroy((function(){e&&e.close()}))):(console.warn("Returning consumer, hijacking previous WS"),void t.setConnection(e).then(()=>{}));console.log("New Connection",n),i.setConnection(e).then(()=>{}),A.del(n),I.set(n,i),I.ttl(n,86400)})),b.on("upgrade",(function(e,s,n){console.log("Parsing session from request..."),m(e,{},()=>{if(!e.session.uuid)return console.log("Destroying Session"),void s.destroy();console.log("Session is parsed!"),E.handleUpgrade(e,s,n,(function(s){E.emit("connection",s,e)}))})})),b.listen(3e3,()=>{console.log("Listening for example app: http://localhost:3000/go")})},function(e,s){e.exports=require("uuid")},function(e,s){e.exports=require("fs")},function(e,s,n){const{ShortCodeExpireError:i}=n(0),t=n(6),o=n(7),r=n(9);t.setWebSocket(n(1)),e.exports=class{constructor(e,s,n){this.mixerConfig=n,this.uuid=e,this.shortCode=s,this.ws=null,this.tokens=null,this.nonce=0,this.mixer=null,this.onClose=function(){},this.controller=new o(this,this.mixer),this.isMixerReady=!1,this.keepAlive=!1,this.user=null}close(e,s=!1){console.log("consumer closed",this.uuid,e,s),this.ws&&(this.ws.close(),this.ws=null),this.controller&&this.controller.onClose(e,s),!0!==s&&this.keepAlive||(console.log("mixer hard close","hard:",s,"keepAlive:",this.keepAlive),this.mixer&&(this.unsubscribe(),this.mixer.close(),this.mixer=null)),this.onClose()}async setConnection(e){const s=this;if(console.log("consumer connected",this.uuid),null!=this.ws){let e=this.ws;this.ws=null,e.removeEventListener(),e.close()}this.ws=e,this.ws.on("close",n=>{e==s.ws?(console.log("consumer WS closed",n),s.close(n,e)):console.log("consumer previous connection closed",this.uuid,n)}),this.ws.on("message",n=>{if(e!=s.ws)return void console.log("consumer previous connection message",this.uuid,n);console.log(this.uuid,n);let i=JSON.parse(n);this.controller.onMessage(i)}),this.send("HELLO");try{if(!this.tokens){console.log("MIXER_CODE_WAIT",this.shortCode.code),this.send("MIXER_CODE_WAIT",this.shortCode);let e=await this.shortCode.waitForAccept();this.tokens=e.data}}catch(e){if(e instanceof i&&!this.isMixerReady)return console.warn("MIXER_CODE_EXPIRE",this.shortCode.code),this.send("MIXER_CODE_EXPIRE",this.shortCode.code),void this.close("short code expired",!0)}if(console.log("MIXER_CODE_ACCEPT",this.shortCode.code),this.send("MIXER_CODE_ACCEPT",this.shortCode.code),this.mixerResource("GET","/users/current").then(e=>{this.user;this.user=e,console.log("MIXER_IDENTIFY",this.user),this.send("MIXER_IDENTIFY",this.user),this.subscribe()}),null==this.mixer&&(console.log("consumer creating mixer",this.uuid),this.mixer=new t.GameClient,this.controller.setMixer(this.mixer)),this.isMixerReady)return console.log("Already have mixer, saying hello!",this.uuid),this.send("MIXER_OPEN"),void this.controller.onReady();this.mixer.on("error",e=>{console.error("An error has occured in mixplay",this.uuid,e),s.close("Mixplay has returned an error")}),this.mixer.on("close",()=>{console.warn("consumer's mixer closed"),s.isMixerReady=!1}),this.mixer.open({authToken:this.tokens.accessToken,versionId:this.mixerConfig.MIXER_GAME_VERSION}).then(()=>(console.log("consumer opened",this.uuid),s.send("MIXER_OPEN"),s.isMixerReady=!0,s.controller.onReady(),s.mixer.ready(!0))).catch(e=>{console.error("consumer failed to open mixer",e),s.remembered=!1,s.send("ERROR",e),s.close("open exception",!0)})}subscribe(){console.log("consumer subscribed",this.uuid),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:update`,e=>{this.send("CARNIA_CHANNEL_UPDATE",e);const s=this.user.channel.costreamId;this.user.channel=Object.assign(this.user.channel,e),console.log("MIXER_IDENTIFY",this.user),this.send("MIXER_IDENTIFY",this.user),null!=s&&s!=this.user.channel.costreamId&&(console.log("consumer left costream",this.uuid,s),this.mixerConfig.carnia.unsubscribe(`costream:${s}:update`,this._carniaCostreamUpdate),this.send("CARNIA_COSTREAM_LEAVE",{id:s})),null!=this.user.channel.costreamId&&(console.log("consumer joined costream",this.uuid,this.user.channel.costreamId),this.mixerConfig.carnia.subscribe(`costream:${this.user.channel.costreamId}:update`,this._carniaCostreamUpdate),this.send("CARNIA_COSTREAM_JOIN"))}),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:followed`,e=>this.send("CARNIA_CHANNEL_FOLLOWED",e)),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:hosted`,e=>this.send("CARNIA_CHANNEL_HOSTED",e)),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:subscribed`,e=>this.send("CARNIA_CHANNEL_SUBSCRIBED",e)),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:skill`,e=>this.send("CARNIA_CHANNEL_SKILL",e)),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:patronageUpdate`,e=>this.send("CARNIA_CHANNEL_PATRONAGE_UPDATE",e)),this.mixerConfig.carnia.subscribe(`channel:${this.user.channel.id}:subscriptionGifted`,e=>this.send("CARNIA_CHANNEL_SUBSCRIPTION_GIFTED",e))}_carniaCostreamUpdate(e){this.send("CARNIA_COSTREAM_UPDATE",e)}unsubscribe(){console.log("consumer unsubscribed",this.uuid),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:update`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:followed`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:hosted`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:subscribed`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:skill`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:patronageUpdate`),this.mixerConfig.carnia.unsubscribe(`channel:${this.user.channel.id}:subscriptionGifted`),null!=this.user.channel.costreamId&&this.mixerConfig.carnia.unsubscribe(`costream:${this.user.channel.costreamId}:update`,this._carniaCostreamUpdate)}send(e,s=null){return!!this.ws&&this.ws.send(JSON.stringify({e:e,p:s,n:this.nonce++}))}async mixerResource(e,s,n=null){let i=await r(`${this.mixerConfig.MIXER_API}${s}`,{method:e,body:n?JSON.stringify(n):null,headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.tokens.accessToken}});return await i.json()}}},function(e,s){e.exports=require("@mixer/interactive-node")},function(e,s,n){const i=n(8);e.exports=class extends i{async ready(){const e=this;let s=this.scenes[0].getControls();for(let n in s){let i=s[n];null!=i.emit&&(i.emit=function(s,...n){e.send("EVENT_CONTROL",{event:s,args:n,control:{controlID:i.controlID,disabled:i.disabled,kind:i.kind,meta:i.meta,position:i.position,cost:i.cost,text:i.text}})})}}}},function(e,s){e.exports=class{constructor(e){this.consumer=e,this.uuid=e.uuid,this.mixer=e.mixer,this.scenes=null,this.time=0}setMixer(e){this.mixer=e}async onReady(){this.scenes=await this.mixer.synchronizeScenes(),this.time=await this.mixer.getTime(),console.log(this.uuid,"scenes",this.scenes),console.log(this.uuid,"time",this.time),this.send("PREREADY"),this.ready(),this.send("READY",{})}ready(){}onClose(e,s){}onMessage(e){}send(e,s=null){this.consumer.send("PLAY_"+e,s)}}},function(e,s){e.exports=require("node-fetch")},function(e,s){e.exports=require("node-cache")},function(e,s){e.exports=require("redis")},function(e,s){e.exports=require("express-session")},function(e,s){e.exports=require("express")},function(e,s){e.exports=require("http")},function(e,s){e.exports=require("connect-redis")},function(e,s){e.exports=require("carina")}]);